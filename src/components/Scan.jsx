import { useState } from "react";
import { saveRecords, uploadAndScanFiles } from "./utils/axiosInstance";
import { toast } from "react-toastify";

const Scan = () => {
    const [file, setFile] = useState(null);

    const [isFileSelected, setIsFileSelected] = useState(false);
    const [isDataLoading, setIsDataLoading] = useState(false);
    const [isUploaded, setIsUploaded] = useState(false);
    const [data, setData] = useState([]);
    const [isSaveClkd, setIsSaveClkd] = useState(false);

    const selectFile = async (event) => {
        setIsFileSelected(true);
        setFile(event.target);
    }

    const uploadFile = async () => {
        setIsDataLoading(true);
        const data = await uploadAndScanFiles(file.files[0], file.value);
        setIsDataLoading(false);
        setData(data);
        setIsUploaded(true);
        setIsSaveClkd(false);
    }

    const saveRecordsToDb = () => {
        setIsSaveClkd(true);
        const reqBody = data;
        reqBody.userId = localStorage.getItem("user-id");
        saveRecords(reqBody);
        toast.success("Records Saved Successfully");
    }

    return <>
        <div className="d-flex align-items-center justify-content-center mt-5">
            <input type="file" onChange={selectFile} />
            <button className="btn btn-primary" onClick={uploadFile} disabled={!isFileSelected || isDataLoading}>
                <div className="d-flex align-items-center justify-content-center">
                    <div className="mr-2">Upload</div>
                    {isDataLoading == true && 
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="sr-only"></span>
                    </div>}
                </div>
            </button>
        </div>

        {isUploaded ? <> <table class="table table-striped table-dark table-hover">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Error Line</th>
                    <th scope="col">Error Description</th>
                </tr>
            </thead>
            <tbody>
                {data.errors.map((row, i) => {
                    return <tr key={i}>
                        <th scope="row">{i + 1}</th>
                        <td>{"Line number - " + row['Error line']}</td>
                        <td>{row['Error Description']}</td>
                    </tr>
                })}
            </tbody>
        </table>
            <div className="d-flex justify-content-center">
                <button className="btn btn-success mr-2" disabled={isSaveClkd} onClick={saveRecordsToDb}>Save Records</button>
            </div>
        </>
            : <></>}
    </>
}

export default Scan;